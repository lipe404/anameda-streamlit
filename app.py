"""
Aplicativo principal Streamlit para Meta Ads Analytics Dashboard
"""
from src.utils.visualizations import VisualizationUtils
from src.utils.data_processor import DataProcessor
from src.analytics.prescriptive import PrescriptiveAnalytics
from src.analytics.predictive import PredictiveAnalytics
from src.analytics.diagnostic import DiagnosticAnalytics
from src.analytics.descriptive import DescriptiveAnalytics
from src.api.meta_api import MetaAdsAPI
from config.settings import Config
import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import sys
import os

# Adiciona o diret√≥rio src ao path
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

# Importa√ß√µes dos m√≥dulos

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="AnaMeDa - Analytics Meta Dados",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS customizado
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
    }
    .metric-card {
        background-color: #f0f2f6;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #1f77b4;
    }
    .success-box {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin: 1rem 0;
    }
    .warning-box {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin: 1rem 0;
    }
    .error-box {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)


def initialize_session_state():
    """Inicializa vari√°veis de estado da sess√£o"""
    if 'data_loaded' not in st.session_state:
        st.session_state.data_loaded = False
    if 'campaign_data' not in st.session_state:
        st.session_state.campaign_data = pd.DataFrame()
    if 'use_sample_data' not in st.session_state:
        st.session_state.use_sample_data = False


def load_data():
    """Carrega dados das campanhas"""
    try:
        if st.session_state.use_sample_data:
            # Usa dados de exemplo
            data = DataProcessor.create_sample_data(days=60)
            st.session_state.campaign_data = data
            st.session_state.data_loaded = True
            return data
        else:
            # Verifica credenciais
            if not Config.validate_credentials():
                st.error(
                    "‚ö†Ô∏è Credenciais da API do Meta n√£o configuradas. Usando dados de exemplo.")
                data = DataProcessor.create_sample_data(days=60)
                st.session_state.campaign_data = data
                st.session_state.data_loaded = True
                return data

            # Conecta com a API do Meta
            with st.spinner("Conectando com a API do Meta Business Suite..."):
                meta_api = MetaAdsAPI()
                data = meta_api.get_all_campaigns_data()

                if data.empty:
                    st.warning(
                        "Nenhum dado encontrado. Usando dados de exemplo.")
                    data = DataProcessor.create_sample_data(days=60)

                # Processa e limpa os dados
                data = DataProcessor.clean_campaign_data(data)
                data = DataProcessor.calculate_derived_metrics(data)

                st.session_state.campaign_data = data
                st.session_state.data_loaded = True
                return data

    except Exception as e:
        st.error(f"Erro ao carregar dados: {str(e)}")
        st.info("Carregando dados de exemplo...")
        data = DataProcessor.create_sample_data(days=60)
        st.session_state.campaign_data = data
        st.session_state.data_loaded = True
        return data


def show_overview_page():
    """P√°gina de vis√£o geral"""
    st.markdown('<h1 class="main-header">üìä AnaMeDa - Analytics Meta Dados</h1>',
                unsafe_allow_html=True)

    # Sidebar para configura√ß√µes
    with st.sidebar:
        st.header("‚öôÔ∏è Configura√ß√µes")

        # Op√ß√£o para usar dados de exemplo
        use_sample = st.checkbox(
            "Usar dados de exemplo",
            value=st.session_state.use_sample_data,
            help="Marque para usar dados simulados em vez da API do Meta"
        )

        if use_sample != st.session_state.use_sample_data:
            st.session_state.use_sample_data = use_sample
            st.session_state.data_loaded = False

        # Bot√£o para recarregar dados
        if st.button("üîÑ Recarregar Dados"):
            st.session_state.data_loaded = False
            st.experimental_rerun()

        # Status da conex√£o
        st.subheader("üì° Status da Conex√£o")
        if Config.validate_credentials() and not st.session_state.use_sample_data:
            st.success("‚úÖ API Configurada")
        else:
            st.warning("‚ö†Ô∏è Usando Dados de Exemplo")

    # Carrega dados se necess√°rio
    if not st.session_state.data_loaded:
        data = load_data()
    else:
        data = st.session_state.campaign_data

    if data.empty:
        st.error("‚ùå Nenhum dado dispon√≠vel")
        return

    # An√°lise descritiva
    descriptive = DescriptiveAnalytics(data)
    overview = descriptive.get_campaign_performance_overview()

    # KPIs principais
    st.subheader("üìà M√©tricas Principais")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric(
            label="üí∞ Gasto Total",
            value=f"R$ {overview.get('total_spend', 0):,.2f}",
            delta="5.2%"
        )

    with col2:
        st.metric(
            label="üëÅÔ∏è Impress√µes",
            value=f"{overview.get('total_impressions', 0):,}",
            delta="12.3%"
        )

    with col3:
        st.metric(
            label="üñ±Ô∏è Clicks",
            value=f"{overview.get('total_clicks', 0):,}",
            delta="8.7%"
        )

    with col4:
        st.metric(
            label="üìä CTR M√©dio",
            value=f"{overview.get('avg_ctr', 0):.2f}%",
            delta="2.1%"
        )

    # Informa√ß√µes do per√≠odo
    st.info(f"üìÖ **Per√≠odo:** {overview.get('date_range', 'N/A')} | "
            f"üéØ **Campanhas Ativas:** {overview.get('campaigns_count', 0)}")

    # Gr√°ficos principais
    st.subheader("üìä An√°lise Visual")

    charts = descriptive.create_performance_charts()

    # Layout em duas colunas
    col1, col2 = st.columns(2)

    with col1:
        if 'spend_timeline' in charts:
            st.plotly_chart(charts['spend_timeline'], use_container_width=True)

        if 'ctr_by_campaign' in charts:
            st.plotly_chart(charts['ctr_by_campaign'],
                            use_container_width=True)

    with col2:
        if 'impressions_clicks' in charts:
            st.plotly_chart(charts['impressions_clicks'],
                            use_container_width=True)

        if 'spend_distribution' in charts:
            st.plotly_chart(charts['spend_distribution'],
                            use_container_width=True)

    # Top campanhas
    st.subheader("üèÜ Top Campanhas por CTR")
    top_campaigns = descriptive.get_top_performing_campaigns('ctr', 5)

    if not top_campaigns.empty:
        st.dataframe(
            top_campaigns[['campaign_name', 'spend',
                           'impressions', 'clicks', 'ctr', 'cpc']].round(2),
            use_container_width=True
        )


def show_diagnostic_page():
    """P√°gina de an√°lise diagn√≥stica"""
    st.header("üîç An√°lise Diagn√≥stica")

    data = st.session_state.campaign_data

    if data.empty:
        st.warning("‚ö†Ô∏è Carregue os dados primeiro na p√°gina Overview")
        return

    diagnostic = DiagnosticAnalytics(data)

    # An√°lise de tend√™ncias
    st.subheader("üìà An√°lise de Tend√™ncias")
    trends = diagnostic.analyze_performance_trends()

    col1, col2 = st.columns(2)

    with col1:
        st.write("**Tend√™ncias Identificadas:**")
        for metric, trend_data in trends.items():
            trend_icon = "üìà" if trend_data['trend'] == 'crescente' else "üìâ" if trend_data['trend'] == 'decrescente' else "‚û°Ô∏è"
            significance = "‚úÖ" if trend_data['significance'] == 'significativo' else "‚ùå"

            st.write(
                f"{trend_icon} **{metric.upper()}**: {trend_data['trend']} {significance}")

    with col2:
        # Gr√°fico de correla√ß√£o
        correlation_matrix = diagnostic.correlation_analysis()
        if not correlation_matrix.empty:
            fig_corr = VisualizationUtils.create_correlation_heatmap(data)
            st.plotly_chart(fig_corr, use_container_width=True)

    # Detec√ß√£o de anomalias
    st.subheader("üö® Detec√ß√£o de Anomalias")

    metric_for_anomaly = st.selectbox(
        "Selecione a m√©trica para an√°lise de anomalias:",
        ['spend', 'impressions', 'clicks', 'ctr', 'cpc']
    )

    anomaly_data = diagnostic.identify_anomalies(metric_for_anomaly)
    anomalies_count = anomaly_data['is_anomaly'].sum()

    col1, col2 = st.columns([1, 3])

    with col1:
        st.metric("üö® Anomalias Detectadas", anomalies_count)

        if anomalies_count > 0:
            st.write("**Datas com Anomalias:**")
            anomaly_dates = anomaly_data[anomaly_data['is_anomaly']]['date'].dt.strftime(
                '%d/%m/%Y').tolist()
            for date in anomaly_dates[:5]:  # Mostra apenas as 5 primeiras
                st.write(f"‚Ä¢ {date}")

    with col2:
        # Gr√°fico de anomalias
        fig_anomaly = px.scatter(
            anomaly_data,
            x='date',
            y=metric_for_anomaly,
            color='is_anomaly',
            title=f'Detec√ß√£o de Anomalias - {metric_for_anomaly.title()}',
            color_discrete_map={True: 'red', False: 'blue'}
        )
        st.plotly_chart(fig_anomaly, use_container_width=True)

    # An√°lise de efici√™ncia
    st.subheader("‚ö° An√°lise de Efici√™ncia das Campanhas")

    efficiency_data = diagnostic.campaign_efficiency_analysis()

    if not efficiency_data.empty:
        col1, col2 = st.columns(2)

        with col1:
            # Distribui√ß√£o por quartil de efici√™ncia
            quartile_counts = efficiency_data['efficiency_quartile'].value_counts(
            )
            fig_quartile = px.pie(
                values=quartile_counts.values,
                names=quartile_counts.index,
                title="Distribui√ß√£o de Campanhas por Efici√™ncia"
            )
            st.plotly_chart(fig_quartile, use_container_width=True)

        with col2:
            # Scatter plot efici√™ncia
            fig_efficiency = px.scatter(
                efficiency_data,
                x='cpc',
                y='ctr',
                size='spend',
                color='efficiency_quartile',
                title='An√°lise de Efici√™ncia: CTR vs CPC',
                hover_data=['campaign_name']
            )
            st.plotly_chart(fig_efficiency, use_container_width=True)

        # Tabela de efici√™ncia
        st.write("**Ranking de Efici√™ncia das Campanhas:**")
        efficiency_display = efficiency_data[[
            'campaign_name', 'spend', 'ctr', 'cpc', 'efficiency_score', 'efficiency_quartile']].round(2)
        efficiency_display = efficiency_display.sort_values(
            'efficiency_score', ascending=False)
        st.dataframe(efficiency_display, use_container_width=True)


def show_predictive_page():
    """P√°gina de an√°lise preditiva"""
    st.header("üîÆ An√°lise Preditiva")

    data = st.session_state.campaign_data

    if data.empty:
        st.warning("‚ö†Ô∏è Carregue os dados primeiro na p√°gina Overview")
        return

    # Configura√ß√µes de previs√£o
    col1, col2, col3 = st.columns(3)

    with col1:
        target_metric = st.selectbox(
            "M√©trica para Previs√£o:",
            ['spend', 'impressions', 'clicks', 'ctr'],
            help="Selecione a m√©trica que deseja prever"
        )

    with col2:
        prediction_days = st.slider(
            "Dias para Prever:",
            min_value=3,
            max_value=30,
            value=7,
            help="N√∫mero de dias futuros para previs√£o"
        )

    with col3:
        models_to_use = st.multiselect(
            "Modelos para Usar:",
            ['ARIMA', 'TensorFlow', 'Linear Regression'],
            default=['ARIMA', 'Linear Regression'],
            help="Selecione os modelos para treinamento"
        )

    if st.button("üöÄ Treinar Modelos e Gerar Previs√µes"):
        predictive = PredictiveAnalytics(data)

        with st.spinner("Treinando modelos... Isso pode levar alguns minutos."):
            # Treina modelos selecionados
            training_results = {}

            if 'ARIMA' in models_to_use:
                with st.spinner("Treinando modelo ARIMA..."):
                    training_results['arima'] = predictive.train_arima_model(
                        target_metric)

            if 'TensorFlow' in models_to_use:
                with st.spinner("Treinando modelo TensorFlow..."):
                    training_results['tensorflow'] = predictive.train_tensorflow_model(
                        target_metric, epochs=30)

            if 'Linear Regression' in models_to_use:
                with st.spinner("Treinando modelo de Regress√£o Linear..."):
                    training_results['linear_regression'] = predictive.train_linear_regression_model(
                        target_metric)

        # Mostra resultados do treinamento
        st.subheader("üìä Resultados do Treinamento")

        for model_name, result in training_results.items():
            if result.get('success', False):
                st.success(
                    f"‚úÖ {model_name.upper()}: Modelo treinado com sucesso")
            else:
                st.error(
                    f"‚ùå {model_name.upper()}: {result.get('error', 'Erro desconhecido')}")

        # Gera previs√µes
        st.subheader("üîÆ Previs√µes Geradas")

        predictions = predictive.generate_predictions(
            target_metric, prediction_days)
        ensemble = predictive.create_ensemble_prediction(
            target_metric, prediction_days)

        # Gr√°fico de previs√µes
        charts = predictive.create_prediction_charts(
            target_metric, prediction_days)

        if 'predictions_comparison' in charts:
            st.plotly_chart(
                charts['predictions_comparison'], use_container_width=True)

        # Tabela de previs√µes
        if not ensemble.empty:
            st.subheader("üìã Tabela de Previs√µes")

            # Formata tabela
            ensemble_display = ensemble.copy()
            ensemble_display['date'] = ensemble_display['date'].dt.strftime(
                '%d/%m/%Y')
            ensemble_display['ensemble_prediction'] = ensemble_display['ensemble_prediction'].round(
                2)

            st.dataframe(ensemble_display, use_container_width=True)

            # Estat√≠sticas das previs√µes
            col1, col2, col3 = st.columns(3)

            with col1:
                st.metric(
                    "üìà Previs√£o M√©dia",
                    f"{ensemble['ensemble_prediction'].mean():.2f}"
                )

            with col2:
                st.metric(
                    "Varia√ß√£o Total",
                    f"{ensemble['ensemble_prediction'].std():.2f}"
                )

            with col3:
                trend = "‚ÜóÔ∏è Crescente" if ensemble['ensemble_prediction'].iloc[-1] > ensemble['ensemble_prediction'].iloc[0] else "‚ÜòÔ∏è Decrescente"
                st.metric("üìà Tend√™ncia", trend)

        # Performance dos modelos
        st.subheader("üéØ Performance dos Modelos")
        model_performance = predictive.get_model_performance_summary(
            target_metric)

        for model_name, performance in model_performance.items():
            with st.expander(f"üìä {model_name.upper()} - Detalhes"):
                st.json(performance)


def show_prescriptive_page():
    """P√°gina de an√°lise prescritiva"""
    st.header("üí° An√°lise Prescritiva e Recomenda√ß√µes")

    data = st.session_state.campaign_data

    if data.empty:
        st.warning("‚ö†Ô∏è Carregue os dados primeiro na p√°gina Overview")
        return

    prescriptive = PrescriptiveAnalytics(data)

    # Plano de a√ß√£o geral
    st.subheader("üéØ Plano de A√ß√£o Estrat√©gico")

    action_plan = prescriptive.generate_action_plan()

    # A√ß√µes imediatas
    st.markdown("### üö® A√ß√µes Imediatas (0-3 dias)")
    for action in action_plan['immediate_actions']:
        st.write(f"‚Ä¢ {action}")

    # A√ß√µes de curto prazo
    st.markdown("### ‚è±Ô∏è A√ß√µes de Curto Prazo (1-2 semanas)")
    for action in action_plan['short_term_actions']:
        st.write(f"‚Ä¢ {action}")

    # A√ß√µes de longo prazo
    st.markdown("### üìÖ A√ß√µes de Longo Prazo (1+ m√™s)")
    for action in action_plan['long_term_actions']:
        st.write(f"‚Ä¢ {action}")

    # Recomenda√ß√µes espec√≠ficas
    st.subheader("üéØ Recomenda√ß√µes Espec√≠ficas")

    # Tabs para diferentes tipos de recomenda√ß√µes
    tab1, tab2, tab3, tab4 = st.tabs(
        ["üí∞ Or√ßamento", "üéØ Lances", "üë• Targeting", "üé® Criativos"])

    with tab1:
        st.markdown("#### üí∞ Otimiza√ß√£o de Or√ßamento")
        budget_recs = prescriptive.budget_optimization_recommendations()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**üìà Aumentar Or√ßamento:**")
            for campaign in budget_recs['increase_budget']['campaigns']:
                st.write(f"‚Ä¢ {campaign}")
            st.info(f"üí° {budget_recs['increase_budget']['reason']}")

        with col2:
            st.markdown("**üìâ Reduzir Or√ßamento:**")
            for campaign in budget_recs['decrease_budget']['campaigns']:
                st.write(f"‚Ä¢ {campaign}")
            st.warning(f"‚ö†Ô∏è {budget_recs['decrease_budget']['reason']}")

        # Potencial economia
        potential_savings = budget_recs['total_budget_reallocation']['potential_savings']
        st.success(f"üí∞ **Economia Potencial:** R$ {potential_savings:,.2f}")

    with tab2:
        st.markdown("#### üéØ Estrat√©gia de Lances")
        bidding_recs = prescriptive.bidding_strategy_recommendations()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**üìâ Reduzir Lances:**")
            for campaign in bidding_recs['reduce_bids']['campaigns']:
                st.write(f"‚Ä¢ {campaign}")
            st.info(f"üí° {bidding_recs['reduce_bids']['action']}")

        with col2:
            st.markdown("**üìà Aumentar Lances:**")
            for campaign in bidding_recs['increase_bids']['campaigns']:
                st.write(f"‚Ä¢ {campaign}")
            st.success(f"üöÄ {bidding_recs['increase_bids']['action']}")

    with tab3:
        st.markdown("#### üë• Otimiza√ß√£o de Targeting")
        targeting_recs = prescriptive.targeting_optimization_recommendations()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**üìÖ Otimiza√ß√£o de Cronograma:**")
            st.write("**Melhores dias:**")
            for day in targeting_recs['schedule_optimization']['increase_budget_days']:
                st.write(f"‚Ä¢ {day}")

        with col2:
            st.markdown("**üë• Expans√£o de Audi√™ncia:**")
            for campaign in targeting_recs['audience_expansion']['high_performing_campaigns'][:3]:
                st.write(f"‚Ä¢ {campaign}")
            st.info("üí° Expandir audi√™ncias similares")

    with tab4:
        st.markdown("#### üé® Otimiza√ß√£o de Criativos")
        creative_recs = prescriptive.creative_optimization_recommendations()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**üîÑ Renovar Criativos:**")
            for campaign in creative_recs['creative_refresh']['campaigns']:
                st.write(f"‚Ä¢ {campaign}")
            st.warning("‚ö†Ô∏è Fadiga de criativo detectada")

        with col2:
            st.markdown("**üß™ Testar Varia√ß√µes:**")
            for campaign in creative_recs['creative_testing']['campaigns'][:3]:
                st.write(f"‚Ä¢ {campaign}")
            st.success("üöÄ Alto potencial para testes")

    # Clustering de campanhas
    st.subheader("üéØ Segmenta√ß√£o de Campanhas")

    clustering_insights = prescriptive.campaign_clustering_insights()

    for cluster_name, cluster_data in clustering_insights.items():
        with st.expander(f"üìä {cluster_name.replace('_', ' ').title()} ({cluster_data['characteristics']['campaign_count']} campanhas)"):

            col1, col2 = st.columns(2)

            with col1:
                st.markdown("**Caracter√≠sticas:**")
                chars = cluster_data['characteristics']
                st.write(f"‚Ä¢ Gasto m√©dio: R$ {chars['avg_spend']:,.2f}")
                st.write(f"‚Ä¢ CTR m√©dio: {chars['avg_ctr']:.2f}%")
                st.write(f"‚Ä¢ CPC m√©dio: R$ {chars['avg_cpc']:.2f}")

            with col2:
                st.markdown("**Campanhas:**")
                for campaign in cluster_data['campaigns'][:5]:
                    st.write(f"‚Ä¢ {campaign}")

            st.markdown("**Recomenda√ß√µes:**")
            for rec in cluster_data['recommendations']:
                st.write(f"üí° {rec}")


def main():
    """Fun√ß√£o principal do aplicativo"""

    # Inicializa estado da sess√£o
    initialize_session_state()

    # Menu lateral
    st.sidebar.title("üöÄ Meta Ads Analytics")
    st.sidebar.markdown("---")

    # Navega√ß√£o
    pages = {
        "Overview": show_overview_page,
        "An√°lise Diagn√≥stica": show_diagnostic_page,
        "An√°lise Preditiva": show_predictive_page,
        "Recomenda√ß√µes": show_prescriptive_page
    }

    selected_page = st.sidebar.selectbox(
        "Selecione a p√°gina:", list(pages.keys()))

    # Informa√ß√µes da API
    st.sidebar.markdown("---")
    st.sidebar.markdown("### üîß Configura√ß√£o da API")

    if Config.validate_credentials():
        st.sidebar.success("‚úÖ Credenciais configuradas")
    else:
        st.sidebar.error("‚ùå Configure as credenciais")
        st.sidebar.markdown("""
        **Para configurar a API do Meta:**
        1. Crie um arquivo `.env`
        2. Adicione suas credenciais:
        ```
        META_APP_ID=seu_app_id
        META_APP_SECRET=seu_app_secret
        META_ACCESS_TOKEN=seu_token
        META_AD_ACCOUNT_ID=act_sua_conta
        ```
        """)

    # Executa p√°gina selecionada
    pages[selected_page]()

    # Footer
    st.sidebar.markdown("---")
    st.sidebar.markdown("""
    <div style='text-align: center'>
        <small>
        üöÄ Meta Ads Analytics Dashboard<br>
        Desenvolvido com Streamlit<br>
        ¬© 2025
        </small>
    </div>
    """, unsafe_allow_html=True)


if __name__ == "__main__":
    main()
